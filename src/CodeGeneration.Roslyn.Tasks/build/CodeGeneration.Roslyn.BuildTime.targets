<?xml version="1.0" encoding="utf-8" ?>
<Project ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  
  <ItemDefinitionGroup>
    <Compile>
      <Generator>MSBuild:GenerateCodeFromAttributes</Generator>
    </Compile>
  </ItemDefinitionGroup>
  
  <Target Name="GenerateCodeFromAttributes" DependsOnTargets="ResolveReferences" BeforeTargets="CoreCompile;PrepareResources">
    
    <PropertyGroup>
      <GenerateCodeFromAttributesToolPathOverride Condition="'$(GenerateCodeFromAttributesToolPathOverride)' == ''">codegen</GenerateCodeFromAttributesToolPathOverride>
      <_CodeGenResponseFileName>$(IntermediateOutputPath)$([System.IO.Path]::GetRandomFileName()).rsp</_CodeGenResponseFileName>
      <_CodeGenerationRoslynGeneratedFilesFileName>$(IntermediateOutputPath)$([System.IO.Path]::GetRandomFileName()).txt</_CodeGenerationRoslynGeneratedFilesFileName>
      <_CodeGenToolWarningText>dotnet-codegen: Failed to generate the list of generated files. The tool didn't run succesfully. Please check https://github.com/AArnott/CodeGeneration.Roslyn for usage instructions.</_CodeGenToolWarningText>
      <_CodeGenResponseFileLines>
@(ReferencePath->'-r%0d%0a%(Identity)', '%0d%0a')
@(GeneratorAssemblySearchPaths->'-generatorSearchPath%0d%0a%(Identity)', '%0d%0a')
--out
$(IntermediateOutputPath)
--projectDir
$(MSBuildProjectDirectory)
--generatedFilesList
$(_CodeGenerationRoslynGeneratedFilesFileName)
--
@(Compile, '%0d%0a')
      </_CodeGenResponseFileLines>
    </PropertyGroup>

    <WriteLinesToFile File="$(_CodeGenResponseFileName)" Lines="$(_CodeGenResponseFileLines)" Overwrite="true" />
    <Delete Condition="Exists('$(_CodeGenerationRoslynGeneratedFilesFileName)') == 'true'" Files="$(_CodeGenerationRoslynGeneratedFilesFileName)" ContinueOnError="true" />
    <Message Text="Running CodeGeneration.Roslyn.Tool" Importance="normal" />
    <Exec Command="dotnet $(GenerateCodeFromAttributesToolPathOverride) &quot;%40$(_CodeGenResponseFileName)&quot;" ContinueOnError="true" />
    <Warning Condition="Exists('$(_CodeGenerationRoslynGeneratedFilesFileName)') != 'true'" Text="$(_CodeGenToolWarningText)" Code="CGR1000" />
    <ReadLinesFromFile File="$(_CodeGenerationRoslynGeneratedFilesFileName)">
      <Output TaskParameter="Lines" ItemName="CodeGenerationRoslynOutput_Compile"/>
      <Output TaskParameter="Lines" ItemName="FileWrites"/>
    </ReadLinesFromFile>

    <ItemGroup>
      <Compile Include="@(CodeGenerationRoslynOutput_Compile)" />
      <FileWrites Include="$(_CodeGenResponseFileName);$(_CodeGenerationRoslynGeneratedFilesFileName)" />
    </ItemGroup>
  </Target>

  <Target Name="CleanCodeGenResponseFile" AfterTargets="CoreClean">
    <Delete Condition="Exists('$(_CodeGenerationRoslynGeneratedFilesFileName)') == 'true'" Files="$(_CodeGenerationRoslynGeneratedFilesFileName)" ContinueOnError="true" />
  </Target>
</Project>
